# Noridoc: installer

Path: @/plugin/src/installer

### Overview

CLI installer for Nori Agent Brain that prompts for configuration, installs features into Claude Code, manages credentials, and tracks installation analytics via Google Analytics, supporting both free (local-only) and paid (backend-integrated) installation modes with directory-based profile system.

### How it fits into the larger codebase

This is the main installer entry point accessed via the nori-ai CLI command from @/plugin/package.json bin. The installer (install.ts) orchestrates the installation process by prompting for credentials (prompt.ts), selecting a profile from available directories, loading/saving configuration (config.ts), and executing feature loaders from @/plugin/src/installer/features. It creates ~/nori-config.json containing auth credentials and selected profile name, and installs components into ~/.claude/. The profile selection determines which complete directory structure (CLAUDE.md, skills/, subagents/, slashcommands/) gets installed from @/plugin/src/installer/features/profiles/config/{profileName}/. Each profile is a self-contained directory with a CLAUDE.md file that defines the profile. Profiles are discovered dynamically by scanning for directories containing CLAUDE.md in @/plugin/src/installer/features/profiles/config/. The installer is also used by the uninstaller (uninstall.ts) which removes installed components. The analytics.ts module tracks installation events to Google Analytics using Firebase, providing visibility into installation patterns and user adoption. Profile switching is handled by profiles.ts (switchProfile, listProfiles) which preserves auth credentials while updating the selected profile in ~/nori-config.json.

The install.ts main function first checks if an existing installation exists using hasExistingInstallation() from version.ts (which returns true if ~/.nori-installed-version or ~/nori-config.json exists). If an installation exists, it runs uninstall for the previously installed version (tracked via version.ts) to ensure clean upgrades, UNLESS the optional skipUninstall parameter is true. The skipUninstall parameter is used during profile switching (see @/plugin/src/installer/cli.ts switch-profile command) to preserve custom user profiles that would otherwise be removed during uninstall. If no installation exists (first-time install), it skips the uninstall step and displays "First-time installation detected." This prevents confusing cleanup messages for first-time users. After the conditional uninstall, it displays the NORI ASCII art banner via asciiArt.ts in interactive mode. The promptForConfig function handles two flows: (1) interactive - prompts for credentials via promptForCredentials, then profile selection via promptForProfileSelection which dynamically discovers profiles by scanning for directories with CLAUDE.md, (2) non-interactive - uses existing config from disk or defaults to free mode with senior-swe profile. The config.ts module manages DiskConfig (credentials + profile.baseProfile in ~/nori-config.json) and runtime Config (installType + profile.baseProfile). After saving config, the LoaderRegistry from features/loaderRegistry.ts executes all feature loaders sequentially. Key loaders: (1) profiles loader copies entire profile directories from @/plugin/src/installer/features/profiles/config/ to ~/.claude/profiles/, (2) claudemd loader reads the selected profile's CLAUDE.md, appends a dynamically-generated skills list by globbing for \*\*/SKILL.md files in the profile's skills/ directory, and embeds everything in a managed block, (3) skills/subagents/slashcommands loaders copy files from the profile's respective subdirectories to ~/.claude/. The installer tracks plugin_install_started and plugin_install_completed events with install_type and non_interactive parameters, and saves the current version using saveInstalledVersion for future upgrade cleanup.

The uninstall.ts module removes all Nori-installed components from the system. The runUninstall() function executes loaders in reverse order using registry.getAllReversed() - this is critical because during install, profiles must run first to create profile directories that other loaders read from, but during uninstall, profiles must run last so slashcommands, subagents, and other loaders can still access profile directories to determine which files to remove. After all loaders complete their individual cleanup, uninstall.ts performs central cleanup: cleanupEmptyDirectories() removes ~/.claude/agents/ and ~/.claude/commands/ if they're empty (preserving user-created content), and cleanupNotificationsLog() removes ~/.nori-notifications.log. Config file removal (~/nori-config.json and ~/.nori-installed-version) only happens when removeConfig=true (user-initiated uninstall via main()), not during upgrade uninstalls where config is preserved.

The version.ts module uses a runtime function pattern for file path construction. Instead of module-level constants like `const VERSION_FILE_PATH = join(process.env.HOME, '.nori-installed-version')`, it provides getVersionFilePath() which computes the path at call time. This ensures that when tests mock process.env.HOME, the mocked value is used rather than the value captured during module load. All version file operations (hasExistingInstallation, getInstalledVersion, saveInstalledVersion) call getVersionFilePath() internally to get the current path. This pattern is critical for test isolation - without it, tests would operate on the real user's home directory files even when HOME is mocked.

The logger.ts module provides console output formatting with ANSI color codes. Standard logging functions (error, success, info, warn, debug) use colors.RED, colors.GREEN, colors.BLUE, colors.YELLOW respectively. Additional formatting helpers (brightCyan, boldWhite, gray) use formatColors for enhanced visual hierarchy in CLI output - these return strings with ANSI codes applied. All log functions in logger.ts also append to /tmp/nori-installer.log asynchronously for debugging. The promptForProfileSelection function in install.ts uses these formatters to display profile options with brightCyan numbers, boldWhite names, and gray indented descriptions, separated by blank lines for improved scannability. The promptForCredentials function displays a wrapped prompt asking users to enter credentials or skip for free tier.

The config.ts module manages three types of configuration: (1) DiskConfig stored in ~/nori-config.json containing auth credentials, profile selection, and user preferences like sendSessionTranscript, (2) runtime Config derived from DiskConfig for feature loaders. The sendSessionTranscript field ('enabled' | 'disabled') defaults to 'enabled' when not present in config file, maintaining backward compatibility. This field is loaded by loadDiskConfig() with default fallback, persisted by saveDiskConfig() when provided, and validated by the JSON schema. The config.ts module is used by both the installer (for managing installation settings) and hooks (for reading user preferences like session transcript opt-out).

### Things to Know

The installer modifies several Claude Code configuration files and directories: claude_desktop_config.json, CLAUDE.md, ~/.claude/hooks, ~/.claude/subagents, ~/.claude/slash-commands, ~/.claude/status-line, ~/.claude/profiles, ~/.claude/skills. Profiles are complete, self-contained directory structures at @/plugin/src/installer/features/profiles/config/{profileName}/ containing: CLAUDE.md (base instructions), PROFILE.md (description), skills/ (skill directories with SKILL.md files), subagents/ (subagent .md files), slashcommands/ (slash command .md files). The profile discovery mechanism in install.ts scans for any directory with a CLAUDE.md file, making it easy to add new profiles by creating a new directory. Each profile is installed to ~/.claude/profiles/{profileName}/ with the same structure. Built-in profiles (those with `"builtin": true` in profile.json) are identified by metadata and only built-in profiles are removed during uninstall operations, allowing custom user profiles to persist across profile switches and upgrades. The CLAUDE.md managed block contains both the profile's base instructions AND a dynamically-generated skills list created by globbing for all SKILL.md files in the profile's skills/ directory and formatting them with paths, names, and descriptions from frontmatter. Configuration is stored in ~/nori-config.json with auth credentials and profile.baseProfile, checked by ConfigManager in @/plugin/src/api/base.ts. The installer is idempotent - running multiple times performs a clean uninstall of the previous version before installing the new version. Profile switching via /switch-nori-profile (implemented in @/plugin/src/installer/cli.ts) preserves both auth credentials and custom user profiles by calling installMain with skipUninstall=true, which bypasses the uninstall step entirely and updates profile.baseProfile in ~/nori-config.json. Changes to CLAUDE.md take effect in new conversations without requiring a Claude Code restart. Paid skills are prefixed with "paid-" in the source directory but installed without the prefix for paid tier users; free tier users skip paid- skills entirely. The build system (build.sh, bundle-skills.ts) bundles paid skill script.js files using esbuild to create standalone executables with all dependencies inlined, making them portable and executable from ~/.claude/skills/.

The installer creates an install-in-progress marker file at ~/.nori-install-in-progress at the start of installation (after tracking plugin_install_started event) and deletes it on successful completion (after saveInstalledVersion). This marker contains the version being installed and is checked by the statusline to display error messages if installation fails. If the marker persists after 24 hours, the statusline suggests manual removal. This mechanism ensures users are notified of failed autoupdate installations via the statusline rather than silently having an incomplete installation.

Analytics tracking is non-blocking - all operations in analytics.ts are wrapped in try/catch to ensure installation never fails due to analytics errors. The analytics module uses GA4 Measurement Protocol (measurement ID: G-3YXYKJK38T) for server-side event tracking from Node.js, sending HTTPS POST requests to www.google-analytics.com/mp/collect. Events tracked include plugin_analytics_initialized, plugin_install_started, plugin_install_completed, plugin_uninstall_started, plugin_uninstall_completed, and nori_session_started (tracked by autoupdate hook on SessionStart with metadata: installed_version, update_available, install_type). All events include tilework_event_user_id, tilework_user_id (set from nori-config.json username for paid users, null for free users), session_id, and engagement_time_msec parameters to match backend analytics conventions. The GA4_API_SECRET environment variable must be set for events to be sent to Google Analytics - without it, events are logged to console but not transmitted. A unique client_id is generated per installation session using crypto.randomUUID().

**Test Isolation:** Tests that perform file operations MUST mock process.env.HOME to redirect all file operations to temporary directories. This applies to all functions that construct file paths using process.env.HOME, including getConfigPath() in @/plugin/src/installer/config.ts (returns ~/nori-config.json) and getVersionFilePath() in @/plugin/src/installer/version.ts (returns ~/.nori-installed-version). The removeConfigFile() function in @/plugin/src/installer/uninstall.ts constructs both config and version paths using process.env.HOME, so mocking HOME is the ONLY way to ensure tests don't delete real user files. Tests follow this pattern: (1) save originalHome in beforeEach, (2) create temp directory using fs.mkdtemp(), (3) set process.env.HOME to temp directory, (4) restore originalHome in afterEach (handling both defined and undefined cases with `if (originalHome !== undefined) { process.env.HOME = originalHome } else { delete process.env.HOME }`), (5) clean up temp directory with fs.rm(tempDir, { recursive: true, force: true }). The @/plugin/src/installer/version.test.ts and @/plugin/src/installer/install.integration.test.ts both include safety tests "should never delete real user config file" that explicitly verify: (a) CONFIG_PATH points to temp directory, not real home, (b) real config file is never touched during test operations, (c) process.env.HOME contains '/tmp/' and the test directory name. This pattern is established across the codebase in config.test.ts, uninstall.test.ts, version.test.ts, install.integration.test.ts, statusline loader tests, and paid skill tests - all tests that interact with HOME-based file paths MUST mock process.env.HOME to prevent test pollution. Without this mocking, tests would delete the user's actual ~/nori-config.json and ~/.nori-installed-version files during cleanup operations.

**CRITICAL: Module Load Time vs Runtime Evaluation:** Path constants that depend on process.env.HOME MUST be computed at runtime (inside beforeEach), NEVER at module load time. Module-level constants like `const VERSION_FILE_PATH = path.join(process.env.HOME, '.nori-installed-version')` are evaluated when the module loads, BEFORE any test hooks run. This means they capture the real HOME directory even when tests mock HOME in beforeEach. When tests run afterEach cleanup with `fs.unlinkSync(VERSION_FILE_PATH)`, they delete the actual user's file from their real home directory. The correct pattern: (1) declare variable without initialization at module level: `let VERSION_FILE_PATH: string`, (2) create temp directory and mock HOME in beforeEach, (3) THEN compute path: `VERSION_FILE_PATH = path.join(tempDir, '.nori-installed-version')`. This ensures the path uses the mocked temp directory, not the real HOME. This pattern is correctly implemented in @/plugin/src/installer/install.integration.test.ts, @/plugin/src/installer/uninstall.test.ts, and @/plugin/src/installer/version.test.ts (fixed as of this commit). The version.test.ts file previously violated this pattern by computing VERSION_FILE_PATH at module level for both getInstalledVersion and saveInstalledVersion test suites, causing tests to delete the real user's ~/.nori-installed-version file. The fix moved path computation from module level to inside beforeEach after mocking HOME, and added safety verification tests to both suites.
