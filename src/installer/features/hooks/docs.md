# Noridoc: hooks

Path: @/plugin/src/installer/features/hooks

### Overview

Feature loader that configures Claude Code hooks by writing hook configurations directly into ~/.claude/settings.json. Manages six types of hooks: conversation summarization (paid only), desktop notifications with click-to-focus support, auto-updates, nested installation warnings, user notifications for transcript saving that respect sendSessionTranscript configuration, and instant profile switching via UserPromptSubmit interception.

### How it fits into the larger codebase

This feature loader (loader.ts) is registered with @/plugin/src/installer/features/loaderRegistry.ts and executed by @/plugin/src/installer/install.ts during installation. Unlike other feature loaders that copy files, the hooks loader writes hook configurations into ~/.claude/settings.json using Claude Code's native hooks system. Hook scripts from @/plugin/src/installer/features/hooks/config are referenced via absolute paths in the settings.json configuration. The summarization hooks call @/plugin/src/api/conversation.ts to create summary artifacts in the backend.

### Core Implementation

The loader.ts defines six HookInterface objects (summarizeHook, summarizeNotificationHook, autoupdateHook, nestedInstallWarningHook, notifyHook, quickSwitchHook), each providing an install() function that returns hook configurations. For paid installations, configurePaidHooks() installs all six hooks across SessionEnd, PreCompact, SessionStart, Notification, and UserPromptSubmit events. For free installations, configureFreeHooks() installs autoupdate, nested-install-warning, notification, and quick-switch hooks. The loader reads existing settings.json, merges the hooks configuration into the settings object, and writes it back. The validate() function ensures all expected hooks are present and properly configured, checking for both the event types and the specific commands in each hook. Each hook points to a compiled JavaScript file in @/plugin/src/installer/features/hooks/config using Node.js to execute them.

### Things to Know

Hook installation varies by mode: paid installations get conversation memorization hooks (SessionEnd, PreCompact) plus autoupdate, nested-install-warning, notifications, and quick-switch, while free installations get autoupdate (SessionStart), nested-install-warning (SessionStart), desktop notifications (Notification), and quick-switch (UserPromptSubmit). The settings.json structure uses event matchers ('\*' for all sessions, 'auto' for automatic compaction, 'startup' for session start, '' empty for UserPromptSubmit) to control when hooks fire. The summarizeNotificationHook must be registered before summarizeHook in paid mode to ensure users see the notification synchronously before the async summarization begins. Both summarizeNotificationHook and summarizeHook check sendSessionTranscript configuration from disk config to provide consistent user messaging when transcripts are disabled. All hooks gracefully handle errors and exit with code 0 to avoid disrupting Claude Code sessions. The validate() function performs deep inspection of settings.json to verify not just that hooks exist, but that specific scripts (summarize-notification.js, summarize.js, autoupdate.js, notify-hook.sh, nested-install-warning.js) are referenced in the correct events.

The nestedInstallWarningHook runs on SessionStart with the 'startup' matcher and checks for Nori installations in ancestor directories using findAncestorInstallations() from @/plugin/src/utils/path.ts. If ancestor installations are detected, it outputs a systemMessage warning the user about potential duplicate or conflicting configurations. This provides ongoing visibility into nested installation issues, complementing the one-time warning shown during initial installation.

The quickSwitchHook intercepts `/switch-nori-profile` commands at the UserPromptSubmit event to enable instant profile switching without LLM inference. This bypasses the slash command expansion that would otherwise require multiple LLM calls. The hook is installed for both paid and free users since profile switching is a core feature. It uses the `cwd` from the JSON input to locate profiles at `{cwd}/.claude/profiles/` and the config file at `{cwd}/.nori-config.json`. This makes the hook work correctly for both home directory installations and project-specific installations. It returns either a `{decision: "block", reason: "..."}` response for direct user output (listing profiles or showing errors) or `{hookSpecificOutput: {additionalContext: "..."}}` to add context for Claude to describe the newly switched profile and instruct the user to restart.

The notifyHook (notify-hook.sh) derives its install directory from its script location by going up two directories from `.claude/hooks/`. This allows it to locate the log file at `{install_dir}/.nori-notifications.log` regardless of where Nori is installed.

The autoupdate hook logs all installation activity to ~/.nori-notifications.log for debugging failed updates. It creates an install-in-progress marker file at ~/.nori-install-in-progress containing the version being installed, which is checked by the statusline to display error messages if installation fails. The marker is deleted on successful installation completion by @/plugin/src/installer/install.ts. The autoupdate hook compares the installed version from ~/.nori-installed-version (not the build-time version constant) against the npm registry to ensure retries after partial installation failures. CRITICAL: The autoupdate spawn uses openSync() to get file descriptors for stdio redirection - Node.js spawn() with detached: true requires file descriptors (integers), not stream objects like createWriteStream(). The error and exit event listeners on the child process handle spawn failures and file descriptor cleanup to prevent resource leaks.

Desktop notifications support click-to-focus functionality on Linux X11 and macOS when optional dependencies are installed. On Linux X11, notify-hook.sh captures the active terminal window ID using xdotool before sending the notification, then uses wmctrl or xdotool to restore focus when the user clicks. On macOS, terminal-notifier with the -activate flag brings focus back to the terminal app (auto-detected from $TERM_PROGRAM). Both platforms gracefully degrade to basic notifications without optional tools (wmctrl/xdotool on Linux, terminal-notifier on macOS). Wayland is not yet supported for click-to-focus due to its stricter security model around window management. See @/plugin/src/installer/features/hooks/config/docs.md for installation instructions for optional dependencies.
