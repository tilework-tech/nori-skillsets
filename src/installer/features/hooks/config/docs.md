# Noridoc: config

Path: @/plugin/src/installer/features/hooks/config

### Overview

Executable hook scripts for conversation summarization, desktop notifications, package auto-updates, nested installation warnings, and instant profile switching. Contains six hook implementations that Claude Code invokes at lifecycle events: summarize.ts (memorizes conversations to backend), summarize-notification.ts (displays sync user notification), autoupdate.ts (checks and installs package updates), nested-install-warning.ts (warns about ancestor installations), notify-hook.sh (cross-platform desktop notifications), and quick-switch.ts (intercepts profile switch commands for instant execution).

### How it fits into the larger codebase

This folder contains the actual hook implementations referenced by @/plugin/src/installer/features/hooks/loader.ts in ~/.claude/settings.json. The hooks are executed by Claude Code at specific lifecycle events. The summarize.ts hook calls @/plugin/src/api/conversation.ts to create conversation artifacts in the backend. The autoupdate.ts hook uses npm to check for and install new versions of the nori-ai package. The nested-install-warning.ts hook uses findAncestorInstallations() from @/plugin/src/utils/path.ts to detect conflicting Nori installations in parent directories. The notify-hook.sh script provides cross-platform desktop notification support, summarize-notification.ts displays a quick message to users when transcripts are being saved, and quick-switch.ts intercepts `/nori-switch-profile` commands at the UserPromptSubmit event to switch profiles without LLM inference overhead.

### Core Implementation

TypeScript files are compiled to JavaScript during build and executed directly via `node {script}.js` commands configured in settings.json. No shell script wrappers exist anymore (previously removed in favor of direct TypeScript execution).

**summarize.ts**: Accepts SessionEnd or PreCompact as first argument. Reads conversation data from process.argv[3] or stdin. Before processing, checks two conditions: (1) ConfigManager.isConfigured() ensures `.nori-config.json` exists (ConfigManager uses getInstallDirs() to locate the installation directory), (2) Uses getInstallDirs({ currentDir: process.cwd() }) to find the Nori installation directory (searching current directory and all parents), errors if no installation found, then calls loadConfig({ installDir }) to read sendSessionTranscript field and skips if set to 'disabled', displaying "Session Transcript disabled. Use /nori-toggle-session-transcripts to reenable" message. If enabled, parses conversation data JSON to extract transcript_path, reads the full transcript file, and filters empty transcripts using isEmptyTranscript() before calling apiClient.conversation.summarize(). Empty transcript detection checks for user messages with actual content - transcripts containing only metadata (file-history-snapshot, summaries) or only assistant messages are skipped with debug logging. Outputs `{async: true}` on startup to run asynchronously without blocking session end.

**summarize-notification.ts**: Synchronous hook that checks sendSessionTranscript configuration before outputting user feedback. Uses getInstallDirs({ currentDir: process.cwd() }) to find the Nori installation directory (searching current directory and all parents), exits silently if no installation found, then calls loadConfig({ installDir }) to check if sendSessionTranscript is 'disabled'. When disabled, outputs `{systemMessage: "Session transcripts disabled. Use /nori-toggle-session-transcripts to enable"}`. When enabled (or missing for backward compatibility), outputs `{systemMessage: "Saving transcript to nori...\n\n"}`. Provides immediate user feedback about transcript state while summarize.ts runs asynchronously in background. Exports main as async function to support config loading, with silent error handling to prevent session crashes.

**autoupdate.ts**: SessionStart hook that tracks session starts via Google Analytics and checks for package updates. The hook executes in the context of Claude Code's current working directory, which may be a subdirectory of the Nori installation. To locate the config file, the hook first checks if cwd contains a Nori installation using hasNoriInstallation({ dir: cwd }). If not found in cwd, it searches parent directories using findAncestorInstallations({ installDir: cwd }) and uses the closest ancestor installation as the config directory. If no config directory is found, it logs an error to .nori-notifications.log and exits early. Once the config directory is identified, it loads the config using loadConfig({ installDir: configDir }). The Config contains the true installDir (not the configDir itself), which is where Nori is actually installed. The hook then validates that this installDir exists on the filesystem - if the config specifies an installDir that no longer exists, it logs an error and exits.

On successful config load with valid installDir, the hook tracks `nori_session_started` event with metadata: installed_version (from getInstalledVersion({ installDir: configDir.installDir })), update_available (boolean), and install_type ('paid' if auth credentials exist, 'free' otherwise). The tracking call is asynchronous with silent failure to never disrupt session startup. The hook then compares installed version against latest npm registry version using `npm view nori-ai version` and semantic version comparison via the semver package. Uses semver.valid() to validate the npm version string, then semver.gt() to check if latestVersion > installedVersion. This prevents downgrades when local nightly builds (e.g., 14.2.0-nightly.20250120) have higher version numbers than published releases (e.g., 14.1.0), and gracefully handles malformed versions from npm.

When an update is available (latestVersion is valid AND greater than installedVersion), the hook checks the `autoupdate` config field. If `config.autoupdate === "disabled"`, it notifies the user with a systemMessage indicating the new version is available but autoupdate is disabled, suggesting manual update via `npx nori-ai install`. Analytics still track update availability even when autoupdate is disabled. If autoupdate is enabled (default), it spawns a detached background process running `npx nori-ai@{version} install --install-dir={installDir} --non-interactive` to install update and re-run installer preserving user config. The installDir passed to npx is the actual installDir from the config, not the current working directory. Uses openSync() to obtain a file descriptor for redirecting spawn stdio to process.cwd()/.nori-notifications.log (the log file is created in cwd for visibility to the user, not in the actual installDir) - detached spawns require file descriptors (integers), not stream objects. Registers error event listener on child process to log spawn failures and exit event listener to close file descriptor and prevent resource leaks. Outputs systemMessage with version upgrade notification.

**nested-install-warning.ts**: SessionStart hook that warns when multiple Nori installations exist in the directory tree (current directory + ancestors). Loads config to get the installation directory (defaulting to cwd if not set), normalizes it using normalizeInstallDir(). If installDir ends with `.claude`, uses the parent directory to avoid skipping the current installation. Then calls getInstallDirs() from @/plugin/src/utils/path.ts to detect ALL directories with Nori installations (including the current directory). Only warns when `allInstallations.length >= 2` - this prevents false warnings when there is a single installation in a parent directory but no installation in the current directory. When multiple installations are detected, builds a systemMessage warning about Claude Code's recursive CLAUDE.md loading behavior and lists ALL installation paths (not just ancestors) with uninstall commands for each. The warning message header is "All Nori installations found:" to reflect that all installations are listed (not just ancestors). The hook uses logToClaudeSession() helper to output JSON with systemMessage field for Claude Code to display. All errors are caught and logged silently with exit code 0 to prevent disrupting session startup.

**notify-hook.sh**: Shell script (only remaining shell script in config/) that reads JSON notification data from stdin. Derives install directory from script location (going up two directories from `.claude/hooks/`) to locate the log file at `{install_dir}/.nori-notifications.log`. Parses message field using python3/jq/node/sed fallbacks for portability. Platform detection via `uname -s` determines notification method: Linux uses notify-send with click-to-focus actions (X11 only, requires wmctrl/xdotool), macOS tries terminal-notifier with click-to-focus then falls back to osascript (not clickable), Windows tries BurntToast PowerShell module then Windows Forms then msg.exe. Captures terminal window ID on Linux X11 using xdotool before sending notification, then restores focus when user clicks. macOS click-to-focus auto-detects terminal app bundle ID from $TERM_PROGRAM environment variable. Gracefully degrades to basic notifications on Wayland or when optional dependencies are missing.

**quick-switch.ts**: UserPromptSubmit hook that intercepts `/nori-switch-profile` commands for instant profile switching. Reads stdin JSON containing prompt, cwd, session_id, and other Claude Code context. Matches prompt against `/nori-switch-profile` patterns (with or without profile name). Uses getInstallDirs({ currentDir: cwd }) to locate the Nori installation directory - this is CRITICAL because Claude Code may be running from a subdirectory of the installation (e.g., running from `~/project/src` when installed at `~/project`). If no installation is found (getInstallDirs returns empty array), returns `{decision: "block", reason: "No Nori installation found."}` to fail loudly with clear error message. Uses the closest installation (first element of returned array) to locate profiles at `{installDir}/.claude/profiles/` and config at `{installDir}/.nori-config.json`. Validates each profile has a CLAUDE.md file. When invoked without a profile name, returns `{decision: "block", reason: "Available profiles: ..."}` to directly display available profiles without LLM. When invoked with a profile name, writes profile selection to the config file, preserves existing auth config, and returns `{hookSpecificOutput: {additionalContext: "..."}}` with context for Claude to describe the profile and instruct user to restart. Profile descriptions are read from `profile.json` if available. All errors (missing profiles, invalid profile name) return block decisions with user-facing messages. Exits with code 0 on all paths to avoid disrupting Claude Code sessions.

### Things to Know

Hook execution is controlled by @/plugin/src/installer/features/hooks/loader.ts configuration: paid installations install all six hooks (summarize, summarize-notification, autoupdate, nested-install-warning, notify, quick-switch), free installations get autoupdate, nested-install-warning, notify, and quick-switch. The summarize-notification hook must be registered before summarize hook in loader.ts to ensure synchronous user notification appears before async background summarization.

All TypeScript hooks use JSON.stringify() to output structured responses: summarize.ts outputs `{async: true}` to run non-blocking, while autoupdate.ts, nested-install-warning.ts, and summarize-notification.ts output `{systemMessage: "..."}` to inject messages into Claude sessions. Error handling is strictly non-fatal - all hooks catch errors, log via error() function, and exit with code 0 to prevent disrupting Claude Code sessions. Both summarize.ts and summarize-notification.ts check sendSessionTranscript configuration: (1) summarize.ts performs ConfigManager.isConfigured() to ensure `.nori-config.json` exists (ConfigManager uses getInstallDirs() to locate the installation directory), then uses getInstallDirs() again to find the config file location and calls loadConfig({ installDir }) to check sendSessionTranscript field, exiting early with a systemMessage when disabled; (2) summarize-notification.ts uses getInstallDirs() to find the config file location and calls loadConfig({ installDir }) to check the same field, displaying appropriate user feedback ("Saving transcript..." when enabled, "Session transcripts disabled..." when disabled). This ensures consistent user messaging about transcript state across both hooks.

**Bug Fix (v16.0.3+):** Prior versions of summarize.ts, summarize-notification.ts, and analytics.ts incorrectly used `process.cwd()` directly as the installDir when loading configuration, instead of using the standard getInstallDirs() pattern. This caused the sendSessionTranscript setting to be ignored when Claude Code was invoked from a subdirectory of the Nori installation (e.g., running from `~/project/src` when Nori is installed at `~/project`), as the hooks would look for `.nori-config.json` at the cwd instead of searching upward through parent directories. The fix ensures all three files now use getInstallDirs({ currentDir: process.cwd() }), check if allInstallations.length === 0, and use allInstallations[0] as the installDir - matching the pattern already used in autoupdate.ts, quick-switch.ts, ConfigManager, and all paid skill scripts.

**Installation Directory Resolution Pattern:** All hooks, skill scripts, slash commands, and the API client MUST use getInstallDirs() from @/plugin/src/utils/path.ts to locate the Nori installation directory. This is CRITICAL because Claude Code may execute these scripts from a subdirectory of the actual installation (e.g., running from `~/project/src` when installed at `~/project`). The pattern is: (1) Call `getInstallDirs({ currentDir: process.cwd() })` at the start of main() or loadConfig(), (2) Check if the returned array is empty - if so, fail loudly with "Error: No Nori installation found." and exit(1) or throw an error, (3) Use `allInstallations[0]` as the installDir for all subsequent path operations (config file, profiles directory, etc.). For TypeScript hooks and skills, this is done via the getInstallDirs() function. For bash-based slash commands, this is done by walking up directories checking for `.nori-config.json` files, following the same logic as getInstallDirs(). This pattern replaced previous approaches that used `process.cwd()` or hardcoded paths like `~/nori-config.json` directly. The getInstallDirs function walks up the directory tree from currentDir to find all directories containing Nori installation markers (`.nori-config.json`, legacy `nori-config.json`, or `.claude/CLAUDE.md` with "NORI-AI MANAGED BLOCK"), returning them in closest-to-furthest order. Never fall back silently to cwd - always fail loudly with a clear error message when no installation is found. This pattern is implemented in quick-switch.ts, all paid skill scripts (paid-recall, paid-memorize, paid-prompt-analysis, paid-list-noridocs, paid-read-noridoc, paid-write-noridoc, paid-sync-noridocs), nori-toggle-session-transcripts slash command, and ConfigManager.loadConfig() in @/plugin/src/api/base.ts.

The isEmptyTranscript() function (exported for testing in summarize.test.ts) uses strict content validation: parses newline-delimited JSON transcript, filters for user message types, and checks if message content (string or array with text) contains non-whitespace. Only transcripts with at least one substantive user message are sent to backend. This prevents unnecessary API calls for metadata-only sessions (file-history-snapshot, auto-compaction summaries, assistant-only exchanges).

The autoupdate.ts spawn mechanism is a critical system boundary - it must be non-blocking to allow Claude Code session to start immediately. The detached spawn pattern with unref() allows the parent process to exit while the update continues in background. IMPORTANT: Node.js spawn() with detached: true requires file descriptors (integers) for stdio, NOT stream objects. Using createWriteStream() causes silent spawn failures because streams cannot be used as stdio in detached mode. The openSync(path, 'a') pattern is required to get a file descriptor for appending to the log file. The error event listener catches spawn failures (e.g., npx not in PATH) and logs to ~/.nori-notifications.log since the parent process exits immediately. The exit event listener closes the file descriptor to prevent resource leaks - without it, file descriptors accumulate across session starts.

Historical note: This directory previously contained abilities-context.ts and skills-context.ts hooks for SessionStart ability/skill discovery. Both were removed - abilities-context.ts was renamed to skills-context.ts during superpowers integration (#104), then skills-context.ts was deleted when skill discovery moved to hardcoded CLAUDE.md generation at install time (#120). Shell script wrappers (autoupdate.sh, summarize.sh, summarize-notification.sh) were also removed in favor of direct TypeScript execution via node commands.

**Nested installation warning bug fix**: Prior to v15.3.0, nested-install-warning.ts used `findAncestorInstallations()` which only checked parent directories, and warned whenever `ancestorInstallations.length > 0`. This caused false warnings when a user had a single Nori installation in a parent directory (e.g., `/home/user/.claude`) but was working in a subdirectory with no installation (e.g., `/home/user/code/project`). The hook incorrectly treated this as a "nested" scenario when in reality only ONE installation existed. The initial fix attempted to change the logic to check `ancestorInstallations.length < 2`, but this introduced a new bug: it required 3+ total installations to trigger the warning (current + 2 ancestors), missing the common case of 2 installations (one at ~ and one at ~/foo/bar). The correct fix (implemented in v16.0.2) uses `getInstallDirs()` to get ALL installations in the directory tree and checks `allInstallations.length >= 2`. Additionally, when installDir ends with `.claude`, the hook now uses the parent directory as the search starting point to ensure the current installation is properly included in the count. This ensures warnings only appear when there are genuinely 2+ installations that would cause Claude Code to load duplicate CLAUDE.md files.

### Optional Dependencies for Click-to-Focus Notifications

The notify-hook.sh script sends desktop notifications when Claude needs attention. By default, notifications work on all platforms but may not support click-to-focus behavior without optional dependencies.

**Linux (X11)**

For clickable notifications that return focus to your terminal, install:

**Ubuntu/Debian:**

```bash
sudo apt-get install libnotify-bin wmctrl xdotool
```

**Fedora:**

```bash
sudo dnf install libnotify wmctrl xdotool
```

**Arch:**

```bash
sudo pacman -S libnotify wmctrl xdotool
```

**Note:** Click-to-focus is not supported on Wayland yet. Basic notifications will still work, but clicking them won't restore terminal focus. The script auto-detects Wayland via $XDG_SESSION_TYPE and gracefully degrades to basic notifications.

**macOS**

For clickable notifications that return focus to your terminal, install terminal-notifier via Homebrew:

```bash
brew install terminal-notifier
```

Without terminal-notifier, notifications will appear via osascript but won't be clickable (clicking opens Script Editor instead).

**Windows**

Windows notifications use built-in PowerShell commands and don't require additional dependencies. Click-to-focus is not currently implemented for Windows.
