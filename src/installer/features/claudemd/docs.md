# Noridoc: claudemd

Path: @/plugin/src/installer/features/claudemd

### Overview

Feature loader for installing CLAUDE.md files with Nori-specific instructions and a dynamically-generated skills list into the global Claude configuration. Reads profile-specific base instructions, discovers all available skills via glob, extracts skill metadata from frontmatter, and embeds the complete skills list in the managed block.

### How it fits into the larger codebase

This feature loader (loader.ts) is registered with @/plugin/src/installer/features/loaderRegistry.ts and executed during installation. It creates or updates CLAUDE.md files that configure Claude Code's behavior, adding Nori-specific workflow instructions for coding tasks. The loader reads profile-specific CLAUDE.md files from ~/.claude/profiles/{profileName}/CLAUDE.md (since commit 70da534, ~/.claude/profiles/ is the source of truth for all profiles) and discovers skills from the profile's skills/ subdirectory. The profiles loader in @/plugin/src/installer/features/profiles runs first during installation to populate ~/.claude/profiles/ from package templates, then this loader reads from that location. The skills list is generated by discovering all SKILL.md files in the selected profile's skills directory and extracting metadata to embed in the managed block so Claude knows what skills are available. Profile switching in @/plugin/src/installer/features/profiles triggers re-execution of this loader to regenerate CLAUDE.md with the new profile's instructions and skills list. The skills list generation replaced the old generateSkillsContext() function that was removed during the PR #197 directory-based profile transition.

### Core Implementation

The loader reads profile-specific CLAUDE.md from ~/.claude/profiles/{profileName}/CLAUDE.md via getProfileClaudeMd() based on the selected profile name from Config (defaulting to 'senior-swe'). After reading the base profile instructions, it applies template substitution via substituteTemplatePaths() from @/plugin/src/utils/template.ts, which replaces placeholders like `{{skills_dir}}`, `{{profiles_dir}}`, `{{commands_dir}}`, and `{{install_dir}}` with actual paths. The path format depends on install location: home directory installs use tilde notation (`~/.claude/skills/`), while custom directory installs use absolute paths (`/custom/path/.claude/skills/`). After substitution, it generates a dynamic skills list by calling generateSkillsList() which: (1) locates the profile's skills directory at ~/.claude/profiles/{profileName}/skills/, (2) uses glob to find all SKILL.md files recursively via findSkillFiles(), (3) extracts frontmatter metadata from each skill using extractFrontMatter() which parses YAML frontmatter between --- delimiters, (4) formats each skill's information via formatSkillInfo() which strips the "paid-" prefix and uses formatInstallPath() from @/plugin/src/utils/template.ts to generate appropriately-formatted paths, and (5) concatenates all formatted skills into a markdown section instructing Claude to check for relevant skills. The skills list is appended to the profile instructions before insertion. The combined content (profile CLAUDE.md + skills list) is inserted into ~/.claude/CLAUDE.md within a managed block pattern (# BEGIN NORI-AI MANAGED BLOCK / # END NORI-AI MANAGED BLOCK). The insertClaudeMd() function handles both creating new files and updating existing ones via regex replacement. The removeClaudeMd() function handles uninstallation by removing the managed block or deleting the file if empty.

### Things to Know

The managed block pattern is critical - it allows the installer to update Nori-specific instructions in CLAUDE.md files without destroying user customizations outside the managed blocks. The architecture changed in commit 70da534 to make ~/.claude/profiles/ the single source of truth - feature loaders now read from the installed profiles directory instead of the package templates, enabling users to create and modify custom profiles. The profiles loader must run before other loaders during installation to populate ~/.claude/profiles/ first. The skills list generation is fault-tolerant: if skills cannot be found or read, it returns an empty string and installation continues. The frontmatter parser (extractFrontMatter) handles missing frontmatter, empty frontmatter, and quoted/unquoted values gracefully. The "paid-" prefix stripping is essential because skills are stored in profiles with names like "paid-recall" but installed to the skills directory without the prefix. Template substitution is critical for configurable installation directories - source markdown files contain placeholders like `{{skills_dir}}` that are replaced at installation time with paths appropriate for the install location (tilde notation for home installs, absolute paths for custom installs). This allows the same source files to work for both `~/.claude` installations and project-specific installations at custom paths. The system relies on the SKILL.md naming convention - all skill files MUST be named SKILL.md or they won't be discovered. Skills list generation happens at installation time, not runtime, so adding new skills to a profile's config requires running `nori-ai install` to regenerate CLAUDE.md. The loader uses ES modules' import.meta.url pattern for path resolution since it runs in an ES module context. CLAUDE.md files are Claude Code's way of receiving custom instructions that modify agent behavior - changes take effect in new conversations without requiring a restart.
