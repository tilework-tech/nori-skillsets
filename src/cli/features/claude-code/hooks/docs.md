# Noridoc: hooks

Path: @/src/cli/features/claude-code/hooks

### Overview

Feature loader that configures Claude Code hooks by writing hook configurations directly into ~/.claude/settings.json. Manages nine types of hooks: conversation summarization (paid only), session statistics, desktop notifications with click-to-focus support, auto-updates, nested installation warnings, user notifications for transcript saving that respect sendSessionTranscript configuration, slash command interception via UserPromptSubmit (registry-based system in intercepted-slashcommands/), and commit-author replacement via PreToolUse interception of Bash git commit commands. Also configures git settings to disable Claude Code's built-in co-author byline in favor of Nori attribution.

### How it fits into the larger codebase

This feature loader (loader.ts) is registered with @/src/cli/features/claude-code/loaderRegistry.ts and executed by @/src/cli/commands/install/install.ts during installation. Unlike other feature loaders that copy files, the hooks loader writes hook configurations into ~/.claude/settings.json using Claude Code's native hooks system. Hook scripts from @/src/cli/features/claude-code/hooks/config are referenced via absolute paths in the settings.json configuration. The summarization hooks call @/src/api/conversation.ts to create summary artifacts in the backend.

### Core Implementation

The loader.ts defines nine HookInterface objects (summarizeHook, summarizeNotificationHook, statisticsHook, statisticsNotificationHook, autoupdateHook, nestedInstallWarningHook, notifyHook, slashCommandInterceptHook, commitAuthorHook), each providing an install() function that returns hook configurations. The loader uses `isPaidInstall({ config })` from @/src/cli/config.ts to determine whether to install paid or free hooks. For paid installations (where `config.auth != null`), configurePaidHooks() installs all nine hooks across SessionEnd, PreCompact, SessionStart, Notification, UserPromptSubmit, and PreToolUse events, and also sets `settings.includeCoAuthoredBy = false` to disable Claude Code's built-in git co-author attribution. For free installations, configureFreeHooks() installs statistics, autoupdate, nested-install-warning, notification, slash-command-intercept, and commit-author hooks, and also sets `settings.includeCoAuthoredBy = false`. The loader reads existing settings.json, merges the hooks configuration and git settings into the settings object, and writes it back. The removeHooks() function removes both the hooks configuration and the includeCoAuthoredBy setting during uninstall, cleaning up empty git objects to avoid polluting settings.json with empty structures. The validate() function ensures all expected hooks are present and properly configured, checking for both the event types and the specific commands in each hook, as well as verifying that includeCoAuthoredBy is set to false. Each hook points to a compiled JavaScript file in @/src/cli/features/claude-code/hooks/config using Node.js to execute them.

### Things to Know

Hook installation varies by mode: paid installations get conversation memorization hooks (SessionEnd, PreCompact) plus statistics, autoupdate, nested-install-warning, notifications, and slash-command-intercept, while free installations get statistics (SessionEnd), autoupdate (SessionStart), nested-install-warning (SessionStart), desktop notifications (Notification), and slash-command-intercept (UserPromptSubmit). Both modes set `includeCoAuthoredBy = false` in settings.json to disable Claude Code's built-in git co-author attribution. The settings.json structure uses event matchers ('\*' for all sessions, 'auto' for automatic compaction, 'startup' for session start, '' empty for UserPromptSubmit) to control when hooks fire. The summarizeNotificationHook must be registered before summarizeHook in paid mode to ensure users see the notification synchronously before the async summarization begins. Similarly, statisticsNotificationHook must be registered before statisticsHook to show users a synchronous message before async statistics calculation. Both summarizeNotificationHook and summarizeHook check sendSessionTranscript configuration from disk config to provide consistent user messaging when transcripts are disabled. All hooks gracefully handle errors and exit with code 0 to avoid disrupting Claude Code sessions. The validate() function performs deep inspection of settings.json to verify not just that hooks exist, but that specific scripts (summarize-notification.js, summarize.js, statistics-notification.js, statistics.js, autoupdate.js, notify-hook.sh, nested-install-warning.js) are referenced in the correct events, and also validates that includeCoAuthoredBy is set to false.

The includeCoAuthoredBy setting works in conjunction with the commitAuthorHook PreToolUse hook to replace Claude Code's attribution with Nori's. The hooks loader sets `includeCoAuthoredBy = false` to disable Claude Code's built-in "Co-Authored-By: Claude" attribution, while the commitAuthorHook intercepts Bash tool calls for git commit commands and programmatically replaces any Claude attribution with "Co-Authored-By: Nori <contact@tilework.tech>" and "ðŸ¤– Generated with [Nori](https://nori.ai)". The hook uses PreToolUse's updatedInput capability (introduced in Claude Code v2.0.10) to modify git commit commands before execution. It handles both simple `-m "message"` format and heredoc `$(cat <<'EOF' ... EOF)` format commits, preserving all original git flags (-a, -s, --amend, etc.) while replacing attribution. This approach is more reliable than CLAUDE.md instructions because it operates at the tool execution level, not the LLM prompt level. During uninstall, removeHooks() removes the includeCoAuthoredBy setting. The validation checks ensure that includeCoAuthoredBy is explicitly set to false (not just missing or undefined), catching cases where users manually modify settings.json or where installation was interrupted. The commit-author hook is installed for both paid and free users since it's a core branding feature.

The nestedInstallWarningHook runs on SessionStart with the 'startup' matcher and checks for Nori installations in ancestor directories using findAncestorInstallations() from @/src/utils/path.ts. If ancestor installations are detected, it outputs a systemMessage warning the user about potential duplicate or conflicting configurations. This provides ongoing visibility into nested installation issues, complementing the one-time warning shown during initial installation.

The slashCommandInterceptHook intercepts slash commands at the UserPromptSubmit event to enable instant execution without LLM inference. This bypasses the slash command expansion that would otherwise require multiple LLM calls. The hook is installed for both paid and free users since these commands are core features. The hook uses a registry pattern (see @/src/cli/features/claude-code/hooks/config/intercepted-slashcommands/) where each command implements the InterceptedSlashCommand interface with matchers (regex patterns) and a run function. Currently registered commands: `/nori-install-location` (shows installation directory), `/nori-switch-profile` (instant profile switching), `/nori-toggle-autoupdate` (toggle autoupdate setting), `/nori-toggle-session-transcripts` (toggle transcript saving). All commands use getInstallDirs() to locate the Nori installation from cwd upward, making the hook work correctly for both home directory installations and project-specific installations. Commands return either a `{decision: "block", reason: "..."}` response for direct user output or `{hookSpecificOutput: {additionalContext: "..."}}` to add context for Claude. Note: Hook-intercepted commands still have corresponding `.md` files in profile slashcommands directories (@/src/cli/features/claude-code/profiles/config/_mixins/) that provide the `description` frontmatter for Claude Code's command palette and user-facing documentation - these markdown files do NOT need `allowed-tools` frontmatter since the hook executes the command directly without LLM processing.

The notifyHook (notify-hook.sh) logs to the consolidated log file at `/tmp/nori.log`. This replaces the previous per-installation log file (`{install_dir}/.nori-notifications.log`) for easier debugging - users now have a single log file to check for all Nori-related output.

The statisticsNotificationHook and statisticsHook work together to display session usage statistics when a session ends. Both hooks are installed for paid and free users. The statisticsNotificationHook runs synchronously first, displaying "Calculating Nori statistics... (Ctrl-C to exit early)" to inform users that statistics are being computed. The statisticsHook then runs asynchronously (outputs `{async: true}` first) to calculate and display an ASCII table with: user/assistant message counts, top 5 tool calls by usage, skills used (detected by parsing Read tool invocations for paths matching `~/.claude/skills/*/SKILL.md`), subagents used (detected by parsing Task tool invocations with subagent_type), and Nori CLAUDE.md detection (checks for markers like "NORI-AI MANAGED BLOCK" or "Following Nori workflow" in transcript). The statistics hook reads the transcript via the `transcript_path` field from stdin JSON (same pattern as summarize.ts). Both hooks use getInstallDirs() to locate the Nori installation and silently exit if no installation is found.

The autoupdate hook is designed to work correctly when Claude Code is running from a subdirectory of the Nori installation. When the hook starts, it first checks if the current working directory contains a Nori installation using hasNoriInstallation(). If not found, it searches parent directories using findAncestorInstallations() to locate the config file. Once found, it loads the config and reads the actual installDir from the config file - this is critical because loadConfig() returns the installDir field from the JSON file, not the directory where the config was found. For example, if Nori was installed at `~/` but Claude Code is running from `~/foo/bar`, the hook finds the config at `~/.nori-config.json` but the config file itself contains `installDir: "~"`, so the hook uses `~` as the installation directory. The hook validates that the installDir from config actually exists before proceeding.

The autoupdate hook logs all installation activity to `/tmp/nori.log` (consolidated log file for all Nori output). It creates an install-in-progress marker file at ~/.nori-install-in-progress containing the version being installed, which is checked by the statusline to display error messages if installation fails. The marker is deleted on successful installation completion by @/src/cli/commands/install/install.ts. The autoupdate hook compares the installed version from the installDir's version file using getInstalledVersion({ installDir }) against the npm registry to ensure retries after partial installation failures. CRITICAL: The autoupdate spawn uses openSync() to get file descriptors for stdio redirection - Node.js spawn() with detached: true requires file descriptors (integers), not stream objects like createWriteStream(). The error and exit event listeners on the child process handle spawn failures and file descriptor cleanup to prevent resource leaks.

Desktop notifications support click-to-focus functionality on Linux X11 and macOS when optional dependencies are installed. On Linux X11, notify-hook.sh captures the active terminal window ID using xdotool before sending the notification, then uses wmctrl or xdotool to restore focus when the user clicks. On macOS, terminal-notifier with the -activate flag brings focus back to the terminal app (auto-detected from $TERM_PROGRAM). Both platforms gracefully degrade to basic notifications without optional tools (wmctrl/xdotool on Linux, terminal-notifier on macOS). Wayland is not yet supported for click-to-focus due to its stricter security model around window management. See @/src/cli/features/claude-code/hooks/config/docs.md for installation instructions for optional dependencies.
