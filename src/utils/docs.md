# Noridoc: utils

Path: @/src/utils

### Overview

Shared utility functions for the plugin package, containing URL utilities for normalization and service URL construction, path utilities for installation directory management and ancestor installation detection, and network/API error handling utilities including custom error classes for network failures, API errors, and skill collision conflicts.

### How it fits into the larger codebase

This folder provides utilities used throughout the plugin package at multiple system boundaries. The normalizeUrl function is used in @/src/api/base.ts to construct API request URLs (combining organizationUrl from config with endpoint paths), in @/src/cli/config.ts to normalize user-provided organizationUrl values before saving to `.nori-config.json`, and is used by the API client throughout the codebase. The identical implementation exists in @/ui/src/utils/url.ts for the web UI, maintaining consistent URL handling across all client packages.

The fetch.ts module provides network error handling utilities used by @/src/api/registrar.ts for registry API operations. It exports custom error classes (`NetworkError`, `ApiError`, `SkillCollisionError`) and type guards (`isNetworkError`, `isApiError`, `isSkillCollisionError`) that enable callers to distinguish between different failure modes. The `SkillCollisionError` is specifically used when uploading skillsets with inline skills that conflict with existing registry skills - it contains conflict details and available resolution actions, enabling the CLI layer (@/src/cli/features/claude-code/hooks/config/intercepted-slashcommands/nori-registry-upload.ts) to implement auto-resolution for unchanged skills.

The path.ts module provides installation directory utilities used by both the installer (@/src/cli/commands/install/install.ts) and the nested-install-warning hook (@/src/cli/features/claude-code/hooks/config/nested-install-warning.ts). The normalizeInstallDir function converts user-provided paths (tilde-prefixed, relative, or absolute) to absolute paths, defaulting to `process.cwd()` if no path is provided. The config file and `.nori` directory are centralized to the home directory -- `getConfigPath()` is zero-arg and always returns `~/.nori-config.json`, and `getNoriDir()`/`getNoriProfilesDir()` are zero-arg and always return `~/.nori` and `~/.nori/profiles` respectively. The findAncestorInstallations function is used during installation and session start to detect conflicting Nori installations in parent directories, which would cause Claude Code to load duplicate or conflicting CLAUDE.md configurations due to its recursive parent directory loading behavior.

### Core Implementation

The url.ts module exports URL normalization and construction functions:

**normalizeUrl:** Accepts { baseUrl: string, path?: string | null } and returns a normalized URL. The function strips all trailing slashes from baseUrl using replace(/\/+$/, ''), handles optional path by ensuring it starts with exactly one leading slash, and concatenates them to prevent double slashes.

**isValidOrgId:** Accepts { orgId: string } and returns a boolean. Validates that the org ID is lowercase alphanumeric with optional hyphens, not starting or ending with a hyphen. Uses the regex pattern `/^[a-z0-9]+(-[a-z0-9]+)*$/`.

**buildWatchtowerUrl:** Accepts { orgId: string } and returns the Watchtower URL as `https://{orgId}.tilework.tech`.

**buildRegistryUrl:** Accepts { orgId: string } and returns the Registry URL as `https://{orgId}.nori-registry.ai`.

**buildOrganizationRegistryUrl:** Accepts { orgId: string } and returns the organization-specific registry URL for noriskillsets.dev. The "public" org maps to the apex domain `https://noriskillsets.dev`, while other orgs map to subdomains like `https://{orgId}.noriskillsets.dev`. Used by registry-upload, registry-download, and skill-download commands to determine the target registry based on package namespace.

**parseNamespacedPackage:** Accepts { packageSpec: string } and returns `{ orgId: string, packageName: string, version: string | null }` or null if invalid. Parses package specifications in formats:
- `package-name` -> `{ orgId: "public", packageName: "package-name", version: null }`
- `package-name@1.0.0` -> `{ orgId: "public", packageName: "package-name", version: "1.0.0" }`
- `org/package-name` -> `{ orgId: "org", packageName: "package-name", version: null }`
- `org/package-name@1.0.0` -> `{ orgId: "org", packageName: "package-name", version: "1.0.0" }`

Non-namespaced packages default to the "public" organization. Used by registry-upload, registry-download, and skill-download commands to extract org, package name, and version from user-provided package specifications. The orgId is then passed to buildOrganizationRegistryUrl to derive the correct registry URL.

These URL construction functions are used by the install command (@/src/cli/commands/install/install.ts) and various registry commands to convert user-provided org IDs into full service URLs. The stored config format remains unchanged (full URLs), so this is purely a UX improvement at the user input layer.

The path.ts module exports types (`InstallationType`, `InstallationInfo`) and functions (`normalizeInstallDir`, `getInstallDirs`, `getInstallDirsWithTypes`) for installation directory management. The `InstallationType` distinguishes between "source" installations (directories with `.nori-config.json`), "managed" installations (directories with `.claude/CLAUDE.md` containing "NORI-AI MANAGED BLOCK"), and "both" (directories with both markers).

**normalizeInstallDir Architecture:** This function accepts { installDir?: string | null } and returns the BASE installation directory (without `.claude` suffix), handling tilde expansion (`~/` becomes home directory), relative path resolution, and path normalization. If no installDir is provided, it defaults to `process.cwd()`. If a path ending with `.claude` is provided, it strips the suffix and returns the parent directory. The `installDir` now only determines where the `.claude/` subdirectory is created (Claude Code configuration). Config and profiles are centralized at `~/.nori-config.json` and `~/.nori/profiles/` regardless of `installDir`.

The `installDir` parameter is still used by Claude-specific path functions (`getClaudeDir`, `getClaudeMdFile`, `getClaudeSettingsFile`, etc.) for the `.claude/` directory, which is project-relative. However, the config file and `.nori` directory are centralized: `getConfigPath()` is zero-arg and returns `~/.nori-config.json`, `getNoriDir()` is zero-arg and returns `~/.nori`, and `getNoriProfilesDir()` is zero-arg and returns `~/.nori/profiles`. The `loadConfig()` and `validateConfig()` functions are also zero-arg and always operate on the centralized config file. Only `saveConfig()` still accepts parameters (for the config data to write), but always writes to `~/.nori-config.json`.

**getInstallDirs Architecture:** This function accepts { currentDir?: string | null } and returns an array of paths to directories with Nori installations, ordered from closest to furthest (empty array if none found). It searches the current directory first (defaulting to process.cwd() if not provided), then walks up ancestor directories starting from the immediate parent. The function inlines the hasNoriInstallation logic to check for three installation markers: (1) `.nori-config.json` (new style), (2) `nori-config.json` (legacy), (3) `.claude/CLAUDE.md` containing "NORI-AI MANAGED BLOCK". This is the PRIMARY function that hooks and skill scripts MUST use to locate installations, as it handles the critical case where Claude Code runs from a subdirectory of the installation. For example, if Nori is installed at `~/project` but Claude Code runs from `~/project/src`, calling getInstallDirs({ currentDir: process.cwd() }) will return `["~/project/src", "~/project"]` if both have installations, or `["~/project"]` if only the parent has an installation. Hooks/skills use the first element (closest installation) for config resolution. This function replaced previous patterns where hooks/skills used process.cwd() directly or custom directory-finding logic. See @/src/cli/features/claude-code/hooks/config/docs.md for the standard usage pattern in hooks and skills.

**getInstallDirs .claude directory handling (v18.1.1 fix):** The ancestor traversal always starts from the immediate parent of currentDir. Previously, the function had faulty logic that skipped to the grandparent when currentDir ended with `.claude` (e.g., when cwd was `~/.claude`). This caused the function to miss the parent directory entirely - for instance, when Claude Code invoked hooks from `~/.claude`, the function would skip `~` and start checking from `/Users`, missing the `.nori-config.json` at `~/.nori-config.json`. This manifested as user-facing bugs where auth credentials were lost when switching profiles because the config file couldn't be found to preserve existing auth, and registry search only searched the public registry because auth couldn't be loaded from the missing config. The fix removes the grandparent skip logic, ensuring consistent behavior regardless of whether Claude Code runs from `~`, `~/.claude`, `~/.claude/profiles`, or any other subdirectory.

**getInstallDirsWithTypes Architecture:** This function accepts { currentDir?: string | null } and returns an array of `InstallationInfo` objects (each with `path` and `type` fields), ordered from closest to furthest. It extends `getInstallDirs` by classifying each installation as "source" (has `.nori-config.json` but no managed CLAUDE.md block), "managed" (has managed CLAUDE.md block but no config file), or "both" (has both). The classification uses two private helper functions: `hasConfigFile()` checks for `.nori-config.json` or legacy `nori-config.json`, while `hasManagedBlock()` reads `.claude/CLAUDE.md` and checks for the "NORI-AI MANAGED BLOCK" marker. This function is used by the `nori-skillsets install-location` command to enable filtering by installation type, allowing other programs to programmatically detect and distinguish between Nori installation sources (where auth, profiles, and config live) and managed installations (where Claude Code configuration is applied).

**hasNoriInstallation Architecture:** This function accepts { dir: string } and returns a boolean indicating whether a directory has a Nori installation. It checks for three installation markers in order: (1) `.nori-config.json` (new style config file), (2) `nori-config.json` (legacy config file), (3) `.claude/CLAUDE.md` containing "NORI-AI MANAGED BLOCK". This function was previously private and is now publicly exported for use by @/src/cli/features/claude-code/hooks/config/autoupdate.ts to detect whether the current working directory contains a Nori installation before searching parent directories. NOTE: Most code should use getInstallDirs instead of hasNoriInstallation, as getInstallDirs handles both current and ancestor directory checking in a single call.

**findAncestorInstallations Architecture:** This function accepts { installDir: string } and returns an array of paths to ancestor directories with Nori installations, ordered from closest to furthest. It uses hasNoriInstallation() to check each directory for installation markers, starting from the parent of the provided installDir (or grandparent if installDir ends with `.claude`). The function walks up the directory tree until reaching the filesystem root, returning all detected ancestor installations. This is used by both @/src/cli/commands/install/install.ts (during installation to warn about conflicting ancestor installations) and @/src/cli/features/claude-code/hooks/config/autoupdate.ts (during session startup to locate the config file when running from a subdirectory).

**findAllInstallations Architecture:** This function accepts { installDir: string } and returns an array of paths to ALL directories with Nori installations (including the current directory), ordered from closest to furthest. Unlike findAncestorInstallations which only checks parent directories, this function starts checking from the normalized installDir itself and walks up the entire directory tree. It uses the same hasNoriInstallation() check for each directory. This function is used exclusively by @/src/cli/features/claude-code/hooks/config/nested-install-warning.ts to detect nested installation scenarios - the hook only warns when 2 or more installations exist anywhere in the directory tree (current directory + ancestors). This fixes a bug where the hook would incorrectly warn when there was only one installation in a parent directory, even if the current directory had no installation.

### Things to Know

URL normalization happens at two critical points: (1) when users provide organizationUrl during installation (installer/config.ts normalizes before saving to `.nori-config.json` to ensure consistent storage format), and (2) when making API requests (api/base.ts combines the stored organizationUrl with endpoint paths like /api/analytics/track). This prevents URL construction bugs from user input variations like "https://example.com/" vs "https://example.com" or paths with/without leading slashes. The utility is used throughout the codebase for consistent URL handling. The implementation is duplicated across @/src/utils/url.ts and @/ui/src/utils/url.ts rather than shared because the packages have different module systems (Node.js vs browser) and build processes.

The findAncestorInstallations function addresses a specific Claude Code behavior: Claude Code recursively loads CLAUDE.md files from all parent directories. If a user has Nori installed at `~` and also at `~/projects/myapp`, Claude Code will load both CLAUDE.md files, resulting in duplicate or conflicting configurations. The function walks up from the installation directory (starting from the grandparent to skip the current install location), checking each directory for Nori installation markers. The check order (`.nori-config.json` first, then `nori-config.json` legacy, then CLAUDE.md content) prioritizes explicit config files over content-based detection. The function stops at the filesystem root (when `path.dirname()` returns the same path) to prevent infinite loops.

**When to use getInstallDirs vs process.cwd():** Code that runs via Claude Code hooks, skill scripts, or slash commands may still use `getInstallDirs()` to detect whether a Nori installation exists in the directory tree. However, config reading is now centralized -- `loadConfig()` and `getConfigPath()` are zero-arg and always read from `~/.nori-config.json`. The `getInstallDirs()` function is still used by `ConfigManager.loadConfig()` in @/src/api/base.ts as a guard to check that an installation exists before reading the centralized config. See @/src/cli/features/claude-code/hooks/config/docs.md for the standard usage pattern in hooks and skills.

**Centralized `.nori` directory:** The `getNoriDir()`, `getNoriProfilesDir()`, and `getConfigPath()` functions are zero-arg and always resolve to `~/.nori`, `~/.nori/profiles`, and `~/.nori-config.json` respectively via `os.homedir()`. The Claude-specific path functions (`getClaudeDir`, etc.) still take an `installDir` parameter for the `.claude/` directory. The `getInstallDirs()` function still returns directories that contain `.nori-config.json` (used to detect installations), but config reading always goes through the centralized path.
