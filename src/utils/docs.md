# Noridoc: utils

Path: @/src/utils

### Overview

Shared utility functions for the plugin package, containing URL normalization helpers for consistent URL formatting and path utilities for installation directory management and ancestor installation detection.

### How it fits into the larger codebase

This folder provides utilities used throughout the plugin package at multiple system boundaries. The normalizeUrl function is used in @/src/api/base.ts to construct API request URLs (combining organizationUrl from config with endpoint paths like /api/artifacts/create), in @/src/cli/config.ts to normalize user-provided organizationUrl values before saving to `.nori-config.json`, and is bundled into all paid skills (paid-memorize, paid-recall, paid-\*-noridoc) by @/src/scripts/bundle-skills.ts since they import the API client. The identical implementation exists in @/ui/src/utils/url.ts for the web UI, maintaining consistent URL handling across all client packages.

The path.ts module provides installation directory utilities used by both the installer (@/src/cli/commands/install/install.ts) and the nested-install-warning hook (@/src/cli/features/claude-code/hooks/config/nested-install-warning.ts). The normalizeInstallDir function converts user-provided paths (tilde-prefixed, relative, or absolute) to absolute paths ending with `.claude`, defaulting to `process.cwd()/.claude` if no path is provided. This pattern is mirrored by getConfigPath() in @/src/cli/config.ts, which also defaults to `process.cwd()` when no custom installDir is provided, ensuring that installation directory and config file location are always in the same base directory. The findAncestorInstallations function is used during installation and session start to detect conflicting Nori installations in parent directories, which would cause Claude Code to load duplicate or conflicting CLAUDE.md configurations due to its recursive parent directory loading behavior.

### Core Implementation

The url.ts module exports a single normalizeUrl function that accepts { baseUrl: string, path?: string | null } and returns a normalized URL. The function strips all trailing slashes from baseUrl using replace(/\/+$/, ''), handles optional path by ensuring it starts with exactly one leading slash, and concatenates them to prevent double slashes. Comprehensive test coverage in url.test.ts validates edge cases including multiple trailing slashes, empty paths, localhost URLs, and query parameters. The function follows the codebase style of named parameters and optional null types.

The path.ts module exports five functions: normalizeInstallDir, getInstallDirs, hasNoriInstallation, findAncestorInstallations, and findAllInstallations.

**normalizeInstallDir Architecture:** This function accepts { installDir?: string | null } and returns the BASE installation directory (without `.claude` suffix), handling tilde expansion (`~/` becomes home directory), relative path resolution, and path normalization. If no installDir is provided, it defaults to `process.cwd()`. If a path ending with `.claude` is provided, it strips the suffix and returns the parent directory. This clarifies that `installDir` represents the base directory where:
- `.nori-config.json` is stored (config file with version tracking in the `version` field)
- `.claude/` subdirectory is created (Claude Code configuration)

The `installDir` parameter is required throughout all internal functions in the codebase. Only CLI entry points (commands/check/check.ts:checkMain, commands/install/install.ts:main, commands/uninstall/uninstall.ts:main, commands/switch-profile/profiles.ts:switchProfile) accept optional installDir and call normalizeInstallDir() at the top before passing the result to all downstream functions. All other functions (getConfigPath, loadConfig, saveConfig, getClaudeDir, etc.) require `installDir: string` as a parameter.

The configuration path follows the same pattern - getConfigPath() in @/src/cli/config.ts requires { installDir: string } and returns `<installDir>/.nori-config.json`. Similarly, getClaudeDir() in @/src/cli/env.ts requires { installDir: string } and returns `<installDir>/.claude`. This ensures all paths are derived from the same base directory.

**getInstallDirs Architecture:** This function accepts { currentDir?: string | null } and returns an array of paths to directories with Nori installations, ordered from closest to furthest (empty array if none found). It searches the current directory first (defaulting to process.cwd() if not provided), then walks up ancestor directories starting from the immediate parent. The function inlines the hasNoriInstallation logic to check for three installation markers: (1) `.nori-config.json` (new style), (2) `nori-config.json` (legacy), (3) `.claude/CLAUDE.md` containing "NORI-AI MANAGED BLOCK". This is the PRIMARY function that hooks and skill scripts MUST use to locate installations, as it handles the critical case where Claude Code runs from a subdirectory of the installation. For example, if Nori is installed at `~/project` but Claude Code runs from `~/project/src`, calling getInstallDirs({ currentDir: process.cwd() }) will return `["~/project/src", "~/project"]` if both have installations, or `["~/project"]` if only the parent has an installation. Hooks/skills use the first element (closest installation) for config resolution. This function replaced previous patterns where hooks/skills used process.cwd() directly or custom directory-finding logic. See @/src/cli/features/claude-code/hooks/config/docs.md for the standard usage pattern in hooks and skills.

**getInstallDirs .claude directory handling (v18.1.1 fix):** The ancestor traversal always starts from the immediate parent of currentDir. Previously, the function had faulty logic that skipped to the grandparent when currentDir ended with `.claude` (e.g., when cwd was `~/.claude`). This caused the function to miss the parent directory entirely - for instance, when Claude Code invoked hooks from `~/.claude`, the function would skip `~` and start checking from `/Users`, missing the `.nori-config.json` at `~/.nori-config.json`. This manifested as two user-facing bugs: (1) `registryAuth` being lost when switching profiles because the config file couldn't be found to preserve existing auth, and (2) registry search only searching the public registry because `registryAuths` couldn't be loaded from the missing config. The fix removes the grandparent skip logic, ensuring consistent behavior regardless of whether Claude Code runs from `~`, `~/.claude`, `~/.claude/profiles`, or any other subdirectory.

**hasNoriInstallation Architecture:** This function accepts { dir: string } and returns a boolean indicating whether a directory has a Nori installation. It checks for three installation markers in order: (1) `.nori-config.json` (new style config file), (2) `nori-config.json` (legacy config file), (3) `.claude/CLAUDE.md` containing "NORI-AI MANAGED BLOCK". This function was previously private and is now publicly exported for use by @/src/cli/features/claude-code/hooks/config/autoupdate.ts to detect whether the current working directory contains a Nori installation before searching parent directories. NOTE: Most code should use getInstallDirs instead of hasNoriInstallation, as getInstallDirs handles both current and ancestor directory checking in a single call.

**findAncestorInstallations Architecture:** This function accepts { installDir: string } and returns an array of paths to ancestor directories with Nori installations, ordered from closest to furthest. It uses hasNoriInstallation() to check each directory for installation markers, starting from the parent of the provided installDir (or grandparent if installDir ends with `.claude`). The function walks up the directory tree until reaching the filesystem root, returning all detected ancestor installations. This is used by both @/src/cli/commands/install/install.ts (during installation to warn about conflicting ancestor installations) and @/src/cli/features/claude-code/hooks/config/autoupdate.ts (during session startup to locate the config file when running from a subdirectory).

**findAllInstallations Architecture:** This function accepts { installDir: string } and returns an array of paths to ALL directories with Nori installations (including the current directory), ordered from closest to furthest. Unlike findAncestorInstallations which only checks parent directories, this function starts checking from the normalized installDir itself and walks up the entire directory tree. It uses the same hasNoriInstallation() check for each directory. This function is used exclusively by @/src/cli/features/claude-code/hooks/config/nested-install-warning.ts to detect nested installation scenarios - the hook only warns when 2 or more installations exist anywhere in the directory tree (current directory + ancestors). This fixes a bug where the hook would incorrectly warn when there was only one installation in a parent directory, even if the current directory had no installation.

### Things to Know

URL normalization happens at two critical points: (1) when users provide organizationUrl during installation (installer/config.ts normalizes before saving to `.nori-config.json` to ensure consistent storage format), and (2) when making API requests (api/base.ts combines the stored organizationUrl with endpoint paths like /api/artifacts/create). This prevents URL construction bugs from user input variations like "https://example.com/" vs "https://example.com" or paths with/without leading slashes. The utility is bundled into paid skills because esbuild inlines all dependencies when creating standalone executables, so the normalizeUrl code appears in every built skill script. The implementation is duplicated across @/src/utils/url.ts and @/ui/src/utils/url.ts rather than shared because the packages have different module systems (Node.js vs browser) and build processes.

The findAncestorInstallations function addresses a specific Claude Code behavior: Claude Code recursively loads CLAUDE.md files from all parent directories. If a user has Nori installed at `~` and also at `~/projects/myapp`, Claude Code will load both CLAUDE.md files, resulting in duplicate or conflicting configurations. The function walks up from the installation directory (starting from the grandparent to skip the current install location), checking each directory for Nori installation markers. The check order (`.nori-config.json` first, then `nori-config.json` legacy, then CLAUDE.md content) prioritizes explicit config files over content-based detection. The function stops at the filesystem root (when `path.dirname()` returns the same path) to prevent infinite loops.

**When to use getInstallDirs vs process.cwd():** Code that runs via Claude Code hooks, skill scripts, slash commands, or the API client MUST use installation directory discovery instead of process.cwd() directly, because Claude Code may execute these scripts from a subdirectory of the installation. For example, if Nori is installed at `~/project` but the user runs Claude Code from `~/project/src`, hooks and skills need to look for `.nori-config.json` at `~/project/.nori-config.json`, not `~/project/src/.nori-config.json`. The installer code (@/src/cli/) uses normalizeInstallDir() at CLI entry points, then passes the installDir parameter down through all functions - this works because the installer is invoked directly by the user with an explicit --install-dir flag. Hooks, skills, slash commands, and the API client don't have this luxury, so they MUST use installation directory discovery. For TypeScript code: (1) Call getInstallDirs({ currentDir: process.cwd() }) at start of main() or loadConfig(), (2) Check if empty and fail loudly with "No Nori installation found.", (3) Use first element as installDir. For bash scripts (slash commands): implement the same directory-walking logic by checking for `.nori-config.json` in the current directory, then walking up parent directories until found or reaching filesystem root. This pattern is implemented in quick-switch.ts, summarize.ts, summarize-notification.ts, analytics.ts (v16.0.3+), all six paid skill scripts (paid-recall, paid-memorize, paid-list-noridocs, paid-read-noridoc, paid-write-noridoc, nori-sync-docs), nori-toggle-session-transcripts slash command (bash implementation), and ConfigManager.loadConfig() in @/src/api/base.ts. See @/src/cli/features/claude-code/hooks/config/docs.md for detailed implementation examples.
